#!/bin/sh

root=${RPI_ROOT:-/media/sd}
boot=$root/boot/firmware
cache=$root/var/cache
share=/usr/local/share/rpi
lib=/var/lib/rpi

ssh=$boot/ssh.txt
userconf=$boot/userconf.txt
bios=$share/bios.img
kernel=$share/kernel.img
locale=$lib/locale.img

default_arch=aarch64
default_cpu=cortex-a72
default_port=22/tcp
default_ram=1G
default_smp=4
default_user=pi
default_password=raspberry
default_cmdline="\
  extends=$boot/cmdline.txt \
  console=ttyAMA0,115200 \
  panic=-1 \
  root=root \
  rootflags=cache=mmap,msize=512000,posixacl,trans=virtio,version=9p2000.L \
  rootfstype=9p \
  !rootwait \
  !fsck.repair \
"

arch=${RPI_ARCH:-$default_arch}
cmdline="$(echo $default_cmdline)$([ "$#" -gt 0 ] && printf '%s\0' "$@" | sed 's/"/""/g' | xargs -0 printf ' "%s"' | sed 's/^ / init=/')"
cpu=$([ "$arch" = "arm" ] && echo "" || echo "$default_cpu")
port="$(echo "${RPI_PORT:-$default_port}" | sed -r 's/(^|\s+)(\d+)(\/(\w+))?(\s+$)?/,hostfwd=\4::\2-:\2/g')"
ram=${RPI_RAM:-$default_ram}
smp=${RPI_CPU:-$default_smp}

[[ "${RPI_SSH:-1}" =~ "^(1|true|TRUE)$" && ! -e $ssh ]] && \
  touch $ssh

[ ! -e $userconf ] && \
  echo "${RPI_USER:-$default_user}:$(echo "${RPI_PASSWORD:-raspberry}" | openssl passwd -1 -stdin)" | tee $userconf >/dev/null

exec qemu-system-$arch \
  -action panic=exit-failure \
  -machine virt \
  -nographic \
  -semihosting \
  -serial mon:stdio \
  ${cpu:+-cpu $cpu} \
  -m $ram \
  -smp $smp \
  -bios $bios \
  -device pvpanic-pci \
  -device virtio-net-device,netdev=net0 \
  -drive file=$locale,format=raw \
  -kernel $kernel \
  -netdev user,id=net0$port \
  -virtfs local,id=boot,mount_tag=boot,multidevs=remap,path=$boot,security_model=none,writeout=immediate \
  -virtfs local,id=cache,mount_tag=cache,multidevs=remap,path=$cache,security_model=none,writeout=immediate \
  -virtfs local,id=root,mount_tag=root,multidevs=remap,path=$root,security_model=none,writeout=immediate \
  -append "$cmdline"

#!/bin/sh

config_kernel=/sd/boot/firmware/cmdline.txt
config_ssh=/sd/boot/firmware/ssh.txt
config_user=/sd/boot/firmware/userconf.txt

# https://www.raspberrypi.com/documentation/computers/configuration.html#ssh-or-ssh-txt
[ ! -f "$config_ssh" ] && [ "$RPI_SSH" = "1" -o "$RPI_SSH" = "true" ] && touch "$config_ssh"

# https://www.raspberrypi.com/documentation/computers/configuration.html#configuring-a-user
[ ! -f "$config_user" -a -n "$RPI_USER" ] \
  && (echo "$RPI_USER:$(echo "$RPI_PASSWORD" | openssl passwd -1 -stdin)" >"$config_user")

qemu-system-aarch64 \
  -serial mon:stdio \
  -nographic \
  -no-reboot \
  -machine virt \
  -cpu cortex-a72 \
  -m 1G \
  -smp 4 \
  -device virtio-net-device,netdev=net0 \
  -netdev user,id=net0,hostfwd=tcp::22-:22 \
  -kernel /sd/boot/firmware/kernel8.img \
  -virtfs local,id=boot,mount_tag=boot,multidevs=remap,path=/sd/boot/firmware,security_model=none \
  -virtfs local,id=root,mount_tag=root,multidevs=remap,path=/sd,security_model=none \
  -append "$(cat "$config_kernel")"
